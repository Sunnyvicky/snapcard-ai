<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapCard AI - Â∞àÊ•≠‰∫∫ËÑàÁÆ°ÂÆ∂</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3a8a">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%231e3a8a'/%3E%3Cstop offset='1' stop-color='%230f172a'/%3E%3C/linearGradient%3E%3Cfilter id='shadow'%3E%3CfeDropShadow dx='0' dy='8' stdDeviation='12' flood-opacity='0.25'/%3E%3C/filter%3E%3C/defs%3E%3Crect width='512' height='512' rx='120' fill='url(%23bg)'/%3E%3Cg filter='url(%23shadow)'%3E%3Crect x='86' y='156' width='340' height='200' rx='20' fill='white'/%3E%3Crect x='86' y='190' width='340' height='8' fill='%23f59e0b'/%3E%3Ccircle cx='160' cy='256' r='35' fill='%23e2e8f0'/%3E%3Crect x='220' y='236' width='140' height='16' rx='4' fill='%2394a3b8'/%3E%3Crect x='220' y='266' width='100' height='12' rx='3' fill='%23cbd5e1'/%3E%3C/g%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%231e3a8a'/%3E%3Cstop offset='1' stop-color='%230f172a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='120' fill='url(%23bg)'/%3E%3Crect x='86' y='156' width='340' height='200' rx='20' fill='white'/%3E%3Crect x='86' y='190' width='340' height='8' fill='%23f59e0b'/%3E%3Ccircle cx='160' cy='256' r='35' fill='%23e2e8f0'/%3E%3Crect x='220' y='236' width='140' height='16' rx='4' fill='%2394a3b8'/%3E%3Crect x='220' y='266' width='100' height='12' rx='3' fill='%23cbd5e1'/%3E%3C/svg%3E">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #f8fafc; color: #1e293b; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10; transform: scaleX(1); }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .scan-line { position: absolute; left: 0; width: 100%; height: 2px; background: #f97316; box-shadow: 0 0 10px #f97316; animation: scan 2s linear infinite; }
        .splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    </style>
</head>
<body>
    <div id="root">
        <div class="splash-screen">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #3b82f6 0%, #0f172a 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.4);">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 512 512" fill="none"><rect x="96" y="156" width="320" height="200" rx="24" fill="white"/><rect x="96" y="190" width="320" height="16" fill="#f97316"/><circle cx="170" cy="256" r="30" fill="#cbd5e1"/><rect x="230" y="240" width="120" height="16" rx="4" fill="#94a3b8"/><rect x="230" y="270" width="80" height="12" rx="3" fill="#e2e8f0"/></svg>
            </div>
            <h1 style="font-size: 20px; font-weight: 900; color: #1e293b; font-family: sans-serif;">SNAPCARD AI</h1>
            <p style="font-size: 14px; color: #64748b; font-family: sans-serif; margin-top: 8px;">‰∫∫ËÑàÔºåÊòØÊúÄÂ•ΩÁöÑË≥áÁî¢</p>
        </div>
    </div>

    <script>window.onerror=function(m){const r=document.getElementById('root');if(r)r.innerHTML='<div style="padding:20px;text-align:center;color:red;margin-top:50px;"><h3>Error</h3><p>'+m+'</p><button onclick="localStorage.clear();location.reload()" style="padding:10px;">Reset</button></div>';};</script>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo, Component } = React;

        const safeLS = {
            getItem: (k) => { try { return localStorage.getItem(k); } catch (e) { return null; } },
            setItem: (k, v) => { try { localStorage.setItem(k, v); } catch (e) { } },
            removeItem: (k) => { try { localStorage.removeItem(k); } catch (e) { } }
        };

        const dbUtils = {
            open: () => new Promise((res, rej) => { try { const r=indexedDB.open('SnapCardDB',1); r.onupgradeneeded=(e)=>{const d=e.target.result;if(!d.objectStoreNames.contains('cards'))d.createObjectStore('cards',{keyPath:'id'});}; r.onsuccess=(e)=>res(e.target.result); r.onerror=(e)=>rej(e.target.error); } catch(e){rej(e);} }),
            getAll: async () => { const db=await dbUtils.open(); return new Promise((res, rej)=>{ const tx=db.transaction(['cards'],'readonly'); const req=tx.objectStore('cards').getAll(); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); },
            put: async (card) => { const db=await dbUtils.open(); return new Promise((res, rej)=>{ const tx=db.transaction(['cards'],'readwrite'); const req=tx.objectStore('cards').put(card); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); },
            delete: async (id) => { const db=await dbUtils.open(); return new Promise((res, rej)=>{ const tx=db.transaction(['cards'],'readwrite'); const req=tx.objectStore('cards').delete(id); req.onsuccess=()=>res(); req.onerror=()=>rej(req.error); }); },
            clear: async () => { const db=await dbUtils.open(); return new Promise((res, rej)=>{ const tx=db.transaction(['cards'],'readwrite'); const req=tx.objectStore('cards').clear(); req.onsuccess=()=>res(); req.onerror=()=>rej(req.error); }); }
        };

        const Icon = ({name,size=20}) => {
            const r=useRef(null); useEffect(()=>{if(r.current&&window.lucide){r.current.innerHTML='';const i=document.createElement('i');i.setAttribute('data-lucide',name);r.current.appendChild(i);window.lucide.createIcons({root:r.current,attrs:{width:size,height:size}});}},[name,size]);
            return <span ref={r} style={{display:'inline-flex',alignItems:'center'}}></span>;
        };

        const compressImage = (file) => new Promise((res, rej) => {
            if (!file) return rej("No file");
            const url = URL.createObjectURL(file); const img = new Image(); img.src = url;
            img.onload = () => { URL.revokeObjectURL(url); const c = document.createElement('canvas'); const m = 1200; let w=img.width, h=img.height; if(w>h){if(w>m){h*=m/w;w=m;}}else{if(h>m){w*=m/h;h=m;}} c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); res(c.toDataURL('image/jpeg', 0.8)); };
            img.onerror = rej;
        });

        const CameraScanner = ({ onCapture, onCancel }) => {
            const videoRef = useRef(null);
            useEffect(() => {
                let stream = null;
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => { stream = s; if (videoRef.current) videoRef.current.srcObject = s; videoRef.current?.play(); }).catch(e => alert("Error: " + e.message));
                return () => stream?.getTracks().forEach(t => t.stop());
            }, []);
            const capture = () => {
                if (!videoRef.current) return;
                const v = videoRef.current; const c = document.createElement("canvas");
                c.width = v.videoWidth; c.height = v.videoHeight;
                c.getContext('2d').drawImage(v, 0, 0);
                onCapture(c.toDataURL("image/jpeg", 0.8));
            };
            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col">
                    <video ref={videoRef} playsInline muted autoPlay className="w-full h-full object-cover" />
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="w-3/4 aspect-[1.6/1] border-2 border-blue-500 rounded-xl relative"><div className="scan-line"></div></div></div>
                    <div className="absolute bottom-10 w-full flex justify-center gap-8 pointer-events-auto">
                        <button onClick={onCancel} className="text-white font-bold p-4">ÂèñÊ∂à</button>
                        <button onClick={capture} className="w-16 h-16 bg-white rounded-full border-4 border-gray-300"></button>
                        <div className="w-12"></div>
                    </div>
                </div>
            );
        };

        function App() {
            const [showSplash, setShowSplash] = useState(true);
            const [view, setView] = useState("home");
            const [cards, setCards] = useState([]);
            const [capturedImage, setCapturedImage] = useState(null); 
            const [backImage, setBackImage] = useState(null); 
            const [currentAvatar, setCurrentAvatar] = useState(null); 
            const [additionalImage, setAdditionalImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [resultData, setResultData] = useState({});
            const [currentCardId, setCurrentCardId] = useState(null);
            const [filterCategory, setFilterCategory] = useState("ÂÖ®ÈÉ®");
            const [apiKey, setApiKey] = useState(() => safeLocalStorage.getItem("snapcard_api_key") || "");
            const [error, setError] = useState(null);
            const [statusMsg, setStatusMsg] = useState("AI ÂàÜÊûê‰∏≠...");
            const [searchQuery, setSearchQuery] = useState(""); 
            const [testStatus, setTestStatus] = useState("idle"); 
            const [testMessage, setTestMessage] = useState("");

            useEffect(() => { setTimeout(() => setShowSplash(false), 2000); }, []);
            useEffect(() => { const l=async()=>{try{const d=await dbUtils.getAll(); setCards(d.sort((a,b)=>b.id-a.id));}catch(e){}}; l(); }, []);
            useEffect(() => { setTimeout(() => window.lucide?.createIcons(), 100); }, [view, cards, resultData]);

            // --- Âæ©Âéü AA ÁâàÊ†∏ÂøÉÂäüËÉΩ ---
            const startScanFlow = () => { if (!apiKey) { setView("settings"); return; } setView("scan"); };
            const handleManualAdd = () => { setResultData({ category: "Â∑•‰Ωú" }); setCapturedImage(null); setBackImage(null); setCurrentAvatar(null); setAdditionalImage(null); setCurrentCardId(null); setView("result"); };
            const handleScanCapture = (base64) => { setCapturedImage(base64); setView("home"); analyze(base64); };
            const handleImageUpload = async (e, setter) => { if (e.target.files[0]) { try { const b = await compressImage(e.target.files[0]); setter(b); } catch(err) { alert("Error"); } } };
            const clearApiKey = () => { setApiKey(""); safeLocalStorage.setItem("snapcard_api_key", ""); setTestStatus("idle"); setTestMessage(""); };

            // --- AAÁâà Ê†∏ÂøÉÂàÜÊûê (‰øÆÂæ© 404) ---
            const analyze = async (base64) => {
                setIsProcessing(true); setError(null); setStatusMsg("AI Ê≠£Âú®ÂàÜÊûêÂêçÁâá...");
                
                try {
                    const cleanKey = apiKey.trim();
                    const imageParts = [{ inlineData: { mimeType: "image/jpeg", data: base64.split(',')[1] } }];
                    const prompt = `ÂàÜÊûêÂêçÁâáÂõûÂÇ≥JSON:{"name":"","jobTitle":"","company":"","mobile":"","tel":"","fax":"","email":"","address":"","category":"Â∑•‰Ωú","note":""}„ÄÇË¶èÂâá:1.ÂàÜmobile/tel/fax 2.companyÂêà‰Ωµ‰∏≠Ëã± 3.category[Â∑•‰Ωú,ÂÆ∂‰∫∫,ÂêåÂ≠∏,ÊúãÂèã]„ÄÇÁÑ°Markdown„ÄÇ`;
                    
                    // ‰ΩøÁî® AA ÁâàÊúÄÈ†ÜÊö¢ÁöÑË®≠ÂÆöÔºå‰ΩÜÊõ¥Êñ∞ API Ë∑ØÂæëÈÅøÂÖç 404
                    const model = "gemini-1.5-flash"; // ÈÄüÂ∫¶Âø´„ÄÅÁ©©ÂÆö
                    let url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${cleanKey}`;
                    
                    let res = await fetch(url, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...imageParts] }] })
                    });

                    // Â¶ÇÊûú v1beta 404ÔºåÂòóË©¶ v1
                    if (res.status === 404) {
                        console.warn("v1beta 404, fallback to v1");
                        url = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${cleanKey}`;
                        res = await fetch(url, {
                            method: "POST", headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...imageParts] }] })
                        });
                    }

                    if (!res.ok) {
                        const err = await res.json().catch(()=>({}));
                        throw new Error(err.error?.message || `HTTP ${res.status}`);
                    }

                    const json = await res.json();
                    let text = json.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("AI ÁÑ°ÂõûÂÇ≥ÁµêÊûú");

                    text = text.replace(/```json|```/g, '').trim();
                    const start = text.indexOf('{'), end = text.lastIndexOf('}');
                    const data = JSON.parse(text.substring(start, end + 1));

                    setResultData(data || { category: "Â∑•‰Ωú" });
                    setBackImage(null); setAdditionalImage(null); setCurrentAvatar(null); setCurrentCardId(null);
                    setView("result");

                } catch (e) {
                    setError(`Ëæ®Ë≠òÂ§±Êïó: ${e.message} (Ë´ãÊ™¢Êü• API Key ÊàñÁ∂≤Ë∑Ø)`);
                    setView("home");
                } finally {
                    setIsProcessing(false);
                }
            };

            const testConnection = async () => {
                if(!apiKey) return setTestMessage("Ë´ãËº∏ÂÖ• Key");
                setTestStatus("testing"); setTestMessage("ÈÄ£Á∑öÊ∏¨Ë©¶‰∏≠...");
                try {
                    const cleanKey = apiKey.trim();
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${cleanKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    if(!res.ok) {
                        const err = await res.json().catch(()=>({}));
                        throw new Error(err.error?.message || `HTTP ${res.status}`);
                    }
                    setTestStatus("success"); setTestMessage("È©óË≠âÊàêÂäüÔºÅAPI Key ÊúâÊïà„ÄÇ");
                } catch(e) { setTestStatus("error"); setTestMessage(e.message); }
            };

            const saveCard = async () => {
                const newData = { id: currentCardId || Date.now(), ...resultData, image: capturedImage, backImage: backImage, avatar: currentAvatar, additionalImage: additionalImage, category: resultData.category||"Â∑•‰Ωú" };
                await dbUtils.put(newData);
                const d = await dbUtils.getAll(); setCards(d.sort((a,b)=>b.id-a.id));
                setView("home");
            };
            const handleDeleteCard = async (id, e) => {
                e.stopPropagation(); if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂºµÂêçÁâáÂóéÔºü")) { await dbUtils.delete(id); setCards(prev => prev.filter(c => c.id !== id)); }
            };
            const exportData = () => {
                const blob = new Blob([JSON.stringify(cards,null,2)], {type:"application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "snapcard_backup.json"; a.click();
            };
            const importData = (e) => {
                const file = e.target.files[0]; if(!file)return;
                const r = new FileReader(); r.onload=async(ev)=>{
                    try { const d = JSON.parse(ev.target.result); for(const c of d) await dbUtils.put(c); 
                    const all = await dbUtils.getAll(); setCards(all.sort((a,b)=>b.id-a.id)); alert("ÂåØÂÖ•ÊàêÂäü"); } catch{alert("Ê†ºÂºèÈåØË™§");}
                }; r.readAsText(file); e.target.value='';
            };
            const clearAllData = async () => {
                if(confirm("Ë≠¶ÂëäÔºöÈÄôÂ∞áÂà™Èô§ÊâÄÊúâË≥áÊñô„ÄÇÁ¢∫ÂÆöÂóéÔºü")) { try { await dbUtils.clear(); setCards([]); safeLocalStorage.removeItem("snapcard_cards"); alert("Â∑≤Ê∏ÖÁ©∫"); } catch (e) { alert("Â§±Êïó"); } }
            };

            if (showSplash) {
                return (
                    <div className="fixed inset-0 bg-[#f8fafc] z-[9999] flex flex-col items-center justify-center">
                        <div style={{ width: '64px', height: '64px', background: 'linear-gradient(135deg, #3b82f6 0%, #0f172a 100%)', borderRadius: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '16px', boxShadow: '0 10px 25px -5px rgba(15, 23, 42, 0.4)' }}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 512 512" fill="none"><rect x="96" y="156" width="320" height="200" rx="24" fill="white"/><rect x="96" y="190" width="320" height="16" fill="#f97316"/><circle cx="170" cy="256" r="30" fill="#cbd5e1"/><rect x="230" y="240" width="120" height="16" rx="4" fill="#94a3b8"/><rect x="230" y="270" width="80" height="12" rx="3" fill="#e2e8f0"/></svg>
                        </div>
                        <h1 style={{ fontSize: '20px', fontWeight: '900', color: '#1e293b', fontFamily: 'sans-serif' }}>SNAPCARD AI</h1>
                        <p style={{ fontSize: '14px', color: '#64748b', fontFamily: 'sans-serif', marginTop: '8px' }}>AAÁâàÂæ©Âàª (Original Logic)</p>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto h-screen bg-gray-50 flex flex-col font-sans border-x border-gray-200">
                    <header className="px-6 pt-12 pb-4 bg-white shadow-sm flex justify-between items-center z-10">
                        <h1 className="text-xl font-black text-blue-600 tracking-tighter">SNAPCARD</h1>
                        <button onClick={() => setView("settings")}><Icon name="settings" className="text-gray-400" /></button>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 relative">
                        {error && <div className="bg-red-100 text-red-600 p-3 rounded-lg mb-4 text-xs font-bold">{error}</div>}

                        {view === "home" && (
                            <div className="space-y-4">
                                {!apiKey && <div onClick={()=>setView("settings")} className="bg-blue-50 p-4 rounded-xl text-blue-600 text-center text-sm font-bold cursor-pointer animate-pulse">üëâ Ë´ãÂÖàË®≠ÂÆö API Key</div>}
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icon name="search" size={16}/></div>
                                    <input type="text" placeholder="ÊêúÂ∞ã..." className="w-full bg-white border border-gray-100 rounded-xl pl-10 pr-4 py-3 text-sm focus:outline-none" value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} />
                                    {searchQuery && <button onClick={()=>setSearchQuery("")} className="absolute right-3 top-1/2 -translate-y-1/2"><Icon name="x" size={14}/></button>}
                                </div>
                                <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                                    {["ÂÖ®ÈÉ®", "Â∑•‰Ωú", "ÂÆ∂‰∫∫", "ÂêåÂ≠∏", "ÊúãÂèã"].map(c => (
                                        <button key={c} onClick={()=>setFilterCategory(c)} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap ${filterCategory===c?"bg-blue-600 text-white":"bg-white text-gray-500 border border-gray-100"}`}>{c}</button>
                                    ))}
                                </div>
                                {cards.filter(c => (filterCategory==="ÂÖ®ÈÉ®" || c.category===filterCategory) && (!searchQuery || (c.name?.includes(searchQuery) || c.company?.includes(searchQuery)))).map(c => (
                                    <div key={c.id} onClick={()=>{setResultData(c);setCapturedImage(c.image);setBackImage(c.backImage);setCurrentAvatar(c.avatar);setAdditionalImage(c.additionalImage);setCurrentCardId(c.id);setView("result");}} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center gap-4">
                                        {c.avatar ? <img src={c.avatar} className="w-12 h-12 rounded-full object-cover"/> : <div className="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 font-bold">{c.name?.[0]}</div>}
                                        <div className="flex-1 min-w-0"><div className="font-bold text-gray-800 truncate">{c.name}</div><div className="text-xs text-gray-500 truncate">{c.company||c.jobTitle}</div></div>
                                        <button onClick={(e)=>handleDeleteCard(c.id,e)} className="p-2 text-gray-300 hover:text-red-500"><Icon name="trash-2" size={16}/></button>
                                    </div>
                                ))}
                                <div className="h-24"></div>
                            </div>
                        )}

                        {view === "settings" && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="key" className="text-blue-500"/> API Ë®≠ÂÆö</h3>
                                    <div style={{height:0,overflow:'hidden'}}><input type="text" /><input type="password" /></div>
                                    <div className="relative mb-4">
                                        <input type="password" autoComplete="off" readOnly onFocus={e=>e.target.removeAttribute('readonly')} value={apiKey} onChange={e=>{setApiKey(e.target.value);safeLocalStorage.setItem("snapcard_api_key",e.target.value);}} className="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm pr-10 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="AIzaSy..." />
                                        {apiKey && <button onClick={clearApiKey} className="absolute right-3 top-3 text-gray-400 hover:text-red-500"><Icon name="x" size={16}/></button>}
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={testConnection} disabled={testStatus==="testing"} className={`flex-1 py-2 rounded-lg text-sm font-bold ${testStatus==="success"?"bg-green-100 text-green-700":testStatus==="error"?"bg-red-100 text-red-700":"bg-blue-100 text-blue-700"}`}>{testStatus==="testing"?"Ê∏¨Ë©¶‰∏≠...":testStatus==="success"?"Ê∏¨Ë©¶ÊàêÂäü":"Ê∏¨Ë©¶ÈÄ£Á∑ö"}</button>
                                        <button onClick={()=>window.open("https://aistudio.google.com/app/apikey")} className="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg text-sm font-bold">ÂèñÂæó Key</button>
                                    </div>
                                    {testMessage && <div className={`text-xs mt-2 p-2 rounded ${testStatus==="error"?"text-red-600 bg-red-50":"text-green-600 bg-green-50"}`}>{testMessage}</div>}
                                </div>
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="database" className="text-purple-500"/> Ë≥áÊñôÁÆ°ÁêÜ</h3>
                                    <div className="space-y-3">
                                        <button onClick={exportData} className="w-full flex justify-between p-3 bg-gray-50 rounded-xl text-gray-700"><span>ÂåØÂá∫ (JSON)</span><Icon name="upload" size={18}/></button>
                                        <label className="w-full flex justify-between p-3 bg-gray-50 rounded-xl text-gray-700 cursor-pointer"><span>ÂåØÂÖ•</span><Icon name="download" size={18}/><input type="file" accept=".json" onChange={importData} className="hidden"/></label>
                                        <button onClick={clearAllData} className="w-full flex justify-between p-3 bg-red-50 text-red-600 rounded-xl"><span>Ê∏ÖÁ©∫Ë≥áÊñô</span><Icon name="trash" size={18}/></button>
                                    </div>
                                </div>
                                <div className="text-center text-xs text-gray-400 mt-8">AA Version Restore</div>
                                <button onClick={()=>setView("home")} className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold mt-4">ËøîÂõû</button>
                            </div>
                        )}

                        {view === "scan" && <CameraScanner onCapture={b=>{setCapturedImage(b);setView("home");analyze(b);}} onCancel={()=>setView("home")} />}

                        {view === "result" && (
                            <div className="bg-white min-h-full rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                                <div className="bg-gray-100 relative group">
                                    {capturedImage ? <img src={capturedImage} className="w-full max-h-64 object-contain" /> : <div className="h-40 flex items-center justify-center text-gray-400">ÁÑ°ÂΩ±ÂÉè</div>}
                                    <label className="absolute bottom-2 right-2 bg-black/50 text-white p-2 rounded-full cursor-pointer"><Icon name="camera" size={16}/><input type="file" accept="image/*" className="hidden" onChange={e=>handleImageUpload(e,setCapturedImage)}/></label>
                                </div>
                                <div className="p-5 flex-1 space-y-4">
                                    <div className="flex gap-4">
                                        <div className="relative w-20 h-20 shrink-0">
                                            {currentAvatar ? <img src={currentAvatar} className="w-20 h-20 rounded-xl object-cover" /> : <div className="w-20 h-20 rounded-xl bg-gray-100 flex items-center justify-center"><Icon name="user" size={32}/></div>}
                                            <label className="absolute -bottom-2 -right-2 bg-white shadow p-1.5 rounded-full cursor-pointer"><Icon name="edit-2" size={12}/><input type="file" accept="image/*" className="hidden" onChange={e=>handleImageUpload(e,setCurrentAvatar)}/></label>
                                        </div>
                                        <div className="flex-1 space-y-2">
                                            <input type="text" value={resultData.name||""} onChange={e=>setResultData({...resultData,name:e.target.value})} placeholder="ÂßìÂêç" className="w-full text-xl font-black bg-transparent border-b focus:outline-none" />
                                            <input type="text" value={resultData.jobTitle||""} onChange={e=>setResultData({...resultData,jobTitle:e.target.value})} placeholder="ËÅ∑Á®±" className="w-full text-sm text-gray-500 bg-transparent border-b focus:outline-none" />
                                        </div>
                                    </div>
                                    <div className="space-y-3 pt-2">
                                        {[
                                            {k:"company",i:"building",p:"ÂÖ¨Âè∏"},{k:"mobile",i:"smartphone",p:"ÊâãÊ©ü"},{k:"tel",i:"phone",p:"ÈõªË©±"},
                                            {k:"fax",i:"printer",p:"ÂÇ≥Áúü"},{k:"email",i:"mail",p:"Email"},{k:"address",i:"map-pin",p:"Âú∞ÂùÄ"}
                                        ].map(f => {
                                            const isLink = (f.k==='mobile'||f.k==='tel'||f.k==='email') && resultData[f.k];
                                            const href = f.k==='email' ? `mailto:${resultData[f.k]}` : `tel:${resultData[f.k]}`;
                                            return (
                                                <div key={f.k} className="flex items-center gap-3 bg-gray-50 p-3 rounded-xl">
                                                    {isLink ? <a href={href} className="text-blue-500 active:text-blue-700"><Icon name={f.i} size={18}/></a> : <Icon name={f.i} className="text-gray-400" size={18}/>}
                                                    <input type="text" value={resultData[f.k]||""} onChange={e=>setResultData({...resultData,[f.k]:e.target.value})} placeholder={f.p} className="flex-1 bg-transparent text-sm focus:outline-none" />
                                                </div>
                                            );
                                        })}
                                        <div className="flex gap-2 py-2">{["Â∑•‰Ωú","ÂÆ∂‰∫∫","ÂêåÂ≠∏","ÊúãÂèã"].map(c=><button key={c} onClick={()=>setResultData({...resultData,category:c})} className={`flex-1 py-2 text-xs rounded-lg font-bold border ${resultData.category===c?"bg-blue-50 border-blue-200 text-blue-600":"border-gray-100"}`}>{c}</button>)}</div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="relative aspect-video bg-gray-50 rounded-xl flex items-center justify-center border border-dashed" onClick={()=>document.getElementById('bu').click()}>{backImage?<img src={backImage} className="w-full h-full object-cover"/>:<span className="text-xs text-gray-400">ËÉåÈù¢</span>}<input id="bu" type="file" className="hidden" onChange={e=>handleImageUpload(e,setBackImage)}/></div>
                                            <div className="relative aspect-video bg-gray-50 rounded-xl flex items-center justify-center border border-dashed" onClick={()=>document.getElementById('au').click()}>{additionalImage?<img src={additionalImage} className="w-full h-full object-cover"/>:<span className="text-xs text-gray-400">ÈôÑ‰ª∂</span>}<input id="au" type="file" className="hidden" onChange={e=>handleImageUpload(e,setAdditionalImage)}/></div>
                                        </div>
                                    </div>
                                    <div className="flex gap-3 pt-4 pb-20">
                                        <button onClick={()=>setView("home")} className="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-100">ÂèñÊ∂à</button>
                                        <button onClick={saveCard} className="flex-1 py-3 rounded-xl font-bold text-white bg-blue-600 shadow-lg">ÂÑ≤Â≠ò</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isProcessing && <div className="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center"><div className="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div><div className="text-blue-900 font-bold animate-pulse">{statusMsg}</div></div>}
                    </main>

                    {view === "home" && (
                        <div className="absolute bottom-6 left-0 w-full flex justify-center z-20 pointer-events-none">
                            <div className="flex items-center gap-6 bg-white px-6 py-3 rounded-full shadow-lg pointer-events-auto border border-gray-100">
                                <button onClick={startScanFlow} className="relative -top-6"><div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg transform rotate-3 hover:rotate-6 transition-transform border-4 border-white"><Icon name="scan-line" size={32} className="text-white"/></div></button>
                                <button onClick={handleManualAdd} className="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600"><div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center"><Icon name="edit" size={20}/></div><span className="text-[10px] font-bold">ÊâãÂãï</span></button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
