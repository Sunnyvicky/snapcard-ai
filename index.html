<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapCard AI - æ™ºæ…§è¾¨è­˜ç©©å®šç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes scan {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(220px); opacity: 0; }
        }
        .scan-line { animation: scan 2s linear infinite; background: linear-gradient(to bottom, transparent, #3b82f6); height: 3px; width: 100%; }
        body { background-color: #000; color: white; margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        video { object-fit: cover; width: 100%; height: 100%; }
        .result-panel { background-color: #f8fafc; color: #1e293b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // API é‡‘é‘°ç”±ç’°å¢ƒè‡ªå‹•è™•ç†
        const apiKey = ""; 

        function App() {
            const [status, setStatus] = useState("ç­‰å¾…å•Ÿå‹•...");
            const [error, setError] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [resultData, setResultData] = useState(null);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            // å•Ÿå‹•ç›¸æ©Ÿ (æå‡è§£æåº¦è‡³ 1080p)
            const startCamera = async () => {
                setStatus("æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...");
                setError(null);
                setResultData(null);
                
                try {
                    const constraints = { 
                        video: { 
                            facingMode: { ideal: "environment" },
                            width: { ideal: 1920 }, // æå‡è‡³ Full HD
                            height: { ideal: 1080 }
                        } 
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.onloadedmetadata = () => {
                            videoRef.current.play().catch(e => console.error("Play failed", e));
                            setIsScanning(true);
                            setStatus("ç›¸æ©Ÿé‹ä½œä¸­ (1080P)");
                        };
                    }
                } catch (err) {
                    setError(`ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: ${err.message}`);
                    setStatus("å¤±æ•—");
                }
            };

            // æ‹ç…§åŠŸèƒ½ (ç¢ºä¿æ“·å–æœ€é«˜ç•«è³ª)
            const takePhoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (video && canvas) {
                    const ctx = canvas.getContext('2d');
                    // æ ¹æ“šå½±ç‰‡æµçš„å¯¦éš›å¤§å°è¨­å®šç•«å¸ƒï¼Œç¢ºä¿ç…§ç‰‡ä¸ç¸®æ°´
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // ä½¿ç”¨è¼ƒé«˜å“è³ªçš„ JPEG
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                    setCapturedImage(dataUrl);
                    setIsScanning(false);
                    
                    const stream = video.srcObject;
                    if (stream) stream.getTracks().forEach(t => t.stop());
                }
            };

            // AI è¾¨è­˜é‚è¼¯ (å„ªåŒ–æŒ‡ä»¤èˆ‡è§£æ)
            const analyzeImage = async (base64Data) => {
                setIsProcessing(true);
                setStatus("AI è¾¨è­˜ä¸­...");
                setError(null);

                const prompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åç‰‡ç§˜æ›¸ã€‚è«‹ä»”ç´°åˆ†æé€™å¼µåç‰‡åœ–ç‰‡ä¸­çš„æ–‡å­—ã€‚å¦‚æœæ˜¯åç‰‡ï¼Œè«‹ä»¥ç¹é«”ä¸­æ–‡å›å‚³ä¸€å€‹ JSON ç‰©ä»¶ã€‚æ¬„ä½å¿…é ˆåŒ…å«ï¼šname (å§“å), jobTitle (è·ç¨±), company (å…¬å¸åç¨±), phone (é›»è©±), email (é›»å­éƒµä»¶), address (åœ°å€)ã€‚è«‹å¿½ç•¥ç„¡é—œçš„é›œè¨Šï¼Œå¦‚æœæ‰¾ä¸åˆ°è©²æ¬„ä½è³‡è¨Šè«‹å›å‚³ç©ºå­—ä¸²ã€‚åªå›å‚³ JSON ç‰©ä»¶ï¼Œåš´ç¦åŒ…å« ```json ç­‰ä»»ä½•é¡å¤–æ–‡å­—ã€‚";
                
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/jpeg", data: base64Data.split(',')[1] } }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json"
                    }
                };

                const delays = [1000, 2000, 4000, 8000, 16000];

                const callApiWithRetry = async (retryCount = 0) => {
                    try {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(payload)
                            }
                        );

                        if (!response.ok) {
                            if (retryCount < 5) {
                                await new Promise(r => setTimeout(r, delays[retryCount]));
                                return callApiWithRetry(retryCount + 1);
                            }
                            throw new Error(`ä¼ºæœå™¨å¿™ç¢Œä¸­ (${response.status})`);
                        }

                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (!text) throw new Error("AI ç„¡æ³•è­˜åˆ¥å…§å®¹ï¼Œè«‹å˜—è©¦æ›´æ›èƒŒæ™¯æˆ–è£œå…‰ã€‚");
                        
                        // å¼·åŒ–è§£æ logic: ç§»é™¤æ½›åœ¨çš„é›œè¨Š
                        const cleanedText = text.replace(/```json/g, "").replace(/```/g, "").trim();
                        const parsedData = JSON.parse(cleanedText);
                        
                        setResultData(parsedData);
                        setStatus("è¾¨è­˜æˆåŠŸ");
                    } catch (err) {
                        if (retryCount < 5) {
                            await new Promise(r => setTimeout(r, delays[retryCount]));
                            return callApiWithRetry(retryCount + 1);
                        }
                        setError(`è¾¨è­˜å‡ºéŒ¯: ${err.message}`);
                        setStatus("è¾¨è­˜å¤±æ•—");
                    } finally {
                        setIsProcessing(false);
                    }
                };

                await callApiWithRetry();
            };

            const resetApp = () => {
                setCapturedImage(null);
                setResultData(null);
                setError(null);
                startCamera();
            };

            return (
                <div className="flex flex-col h-screen relative font-sans overflow-hidden bg-black text-white">
                    {/* é ‚éƒ¨ç‹€æ…‹åˆ— */}
                    <div className="p-4 bg-black/90 flex justify-between items-center z-20 border-b border-white/5">
                        <div className="flex flex-col">
                            <h1 className="text-blue-500 font-black text-sm tracking-tighter italic">SNAPCARD AI</h1>
                            <span className="text-[9px] text-gray-400 font-mono uppercase tracking-[0.2em]">{status}</span>
                        </div>
                        {error && (
                            <div className="bg-red-500/10 px-3 py-1.5 rounded-lg border border-red-500/20 text-red-500 text-[10px] font-bold max-w-[60%] flex items-center gap-2">
                                <i data-lucide="alert-circle" className="w-3 h-3"></i>
                                <span className="truncate">{error}</span>
                            </div>
                        )}
                    </div>

                    {/* ä¸»è¦é¡¯ç¤ºå€åŸŸ */}
                    <div className="flex-1 relative bg-gray-950 flex items-center justify-center overflow-hidden">
                        {!capturedImage && !resultData ? (
                            <video 
                                ref={videoRef} 
                                playsInline 
                                muted 
                                autoPlay 
                                className="h-full w-full object-cover" 
                            />
                        ) : capturedImage && !resultData ? (
                            <div className="w-full h-full flex items-center justify-center bg-black p-4">
                                <img src={capturedImage} className="max-w-full max-h-full object-contain rounded-xl shadow-2xl border-2 border-white/10" alt="Captured" />
                            </div>
                        ) : null}

                        {/* æƒæå°ç„¦æ¡† */}
                        {isScanning && (
                            <div className="absolute inset-0 flex items-center justify-center p-8 pointer-events-none z-10">
                                <div className="w-full aspect-[1.5/1] border-2 border-blue-500/30 rounded-3xl relative overflow-hidden shadow-[0_0_0_2000px_rgba(0,0,0,0.7)]">
                                    <div className="scan-line absolute top-0"></div>
                                    <div className="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-blue-500 rounded-tl-xl"></div>
                                    <div className="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-blue-500 rounded-tr-xl"></div>
                                    <div className="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-blue-500 rounded-bl-xl"></div>
                                    <div className="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-blue-500 rounded-br-xl"></div>
                                </div>
                            </div>
                        )}

                        {/* AI è™•ç†ä¸­å‹•ç•« */}
                        {isProcessing && (
                            <div className="absolute inset-0 bg-blue-600/30 backdrop-blur-3xl flex flex-col items-center justify-center text-white z-30 animate-in fade-in duration-500">
                                <div className="relative w-24 h-24 mb-6">
                                    <div className="absolute inset-0 border-8 border-white/10 rounded-full"></div>
                                    <div className="absolute inset-0 border-8 border-t-blue-400 rounded-full animate-spin"></div>
                                </div>
                                <p className="font-bold tracking-[0.2em] uppercase text-sm">æ­£åœ¨æ·±åº¦è§£æåç‰‡å…§å®¹...</p>
                                <p className="text-[10px] text-white/50 mt-2">è«‹ä¿æŒç¶²è·¯æš¢é€š</p>
                            </div>
                        )}

                        {/* è¾¨è­˜çµæœé¢æ¿ */}
                        {resultData && (
                            <div className="absolute inset-0 z-40 flex flex-col result-panel animate-in slide-in-from-bottom-full duration-700 overflow-hidden">
                                <div className="p-10 flex-1 overflow-y-auto">
                                    <div className="flex items-center gap-6 mb-12">
                                        <div className="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-700 rounded-[2rem] flex items-center justify-center text-white font-black text-3xl shadow-2xl shadow-blue-200 ring-4 ring-white">
                                            {resultData.name?.[0] || "ğŸ‘¤"}
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-3xl font-black text-gray-900 tracking-tight">{resultData.name || "æœªè¾¨è­˜"}</h3>
                                            <p className="text-blue-600 font-bold uppercase tracking-widest text-xs mt-2">{resultData.jobTitle || "è·ä½æœªæä¾›"}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-8">
                                        {[
                                            { icon: "building", label: "æ‰€å±¬å…¬å¸", value: resultData.company },
                                            { icon: "smartphone", label: "è¯çµ¡é›»è©±", value: resultData.phone },
                                            { icon: "at-sign", label: "é›»å­éƒµä»¶", value: resultData.email },
                                            { icon: "map-pinned", label: "è¾¦å…¬åœ°å€", value: resultData.address }
                                        ].map((item, idx) => (
                                            <div key={idx} className="flex items-start gap-6 group">
                                                <div className="w-12 h-12 rounded-2xl bg-gray-50 flex items-center justify-center text-gray-400 shrink-0 group-hover:bg-blue-50 group-hover:text-blue-500 transition-colors shadow-sm">
                                                    <i data-lucide={item.icon} className="w-6 h-6"></i>
                                                </div>
                                                <div className="flex-1 pt-1.5 border-b border-gray-100 pb-2">
                                                    <p className="text-[10px] text-gray-300 uppercase font-black tracking-widest mb-1">{item.label}</p>
                                                    <p className="text-lg font-bold text-gray-800 leading-tight">{item.value || "---"}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-8 bg-white border-t border-gray-100 flex flex-col gap-4 shadow-[0_-20px_50px_rgba(0,0,0,0.08)]">
                                    <button 
                                        onClick={() => alert("å„²å­˜åŠŸèƒ½å³å°‡æ¨å‡ºï¼")}
                                        className="w-full bg-blue-600 text-white py-5 rounded-[2.5rem] font-bold shadow-2xl shadow-blue-200 flex items-center justify-center gap-3 active:scale-[0.97] transition-all"
                                    >
                                        <i data-lucide="check" className="w-6 h-6"></i>
                                        ç¢ºèªä¸¦å„²å­˜åç‰‡
                                    </button>
                                    <button onClick={resetApp} className="w-full text-gray-300 py-2 text-[10px] font-black uppercase tracking-[0.4em]">
                                        æ”¾æ£„ä¸¦é‡æ‹
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* åº•éƒ¨æŒ‰éˆ•æ§åˆ¶å€ */}
                    {!resultData && (
                        <div className="p-12 bg-black flex justify-center items-center gap-12 z-20">
                            {!isScanning && !capturedImage ? (
                                <button onClick={startCamera} className="bg-blue-600 hover:bg-blue-700 text-white px-16 py-5 rounded-full font-bold shadow-2xl shadow-blue-900/40 active:scale-95 transition-all">
                                    å•Ÿå‹•æ™ºæ…§æƒæ
                                </button>
                            ) : capturedImage ? (
                                <div className="flex gap-4 w-full max-w-sm animate-in zoom-in-95 duration-300">
                                    <button onClick={resetApp} className="flex-1 bg-white/5 text-white py-5 rounded-3xl font-bold border border-white/10 active:bg-white/10">
                                        é‡æ‹
                                    </button>
                                    <button onClick={() => analyzeImage(capturedImage)} className="flex-[2] bg-blue-600 text-white py-5 rounded-3xl font-bold shadow-2xl shadow-blue-900/40 active:scale-[0.98]">
                                        é–‹å§‹è¾¨è­˜
                                    </button>
                                </div>
                            ) : (
                                <button onClick={takePhoto} className="w-24 h-24 rounded-full border-[8px] border-white/20 flex items-center justify-center relative active:scale-90 transition-transform">
                                    <div className="w-18 h-18 bg-white rounded-full shadow-[0_0_40px_rgba(255,255,255,0.4)]"></div>
                                </button>
                            )}
                        </div>
                    )}

                    <canvas ref={canvasRef} className="hidden"></canvas>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // è‡ªå‹•åˆå§‹åŒ– Lucide åœ–ç¤º
        const observer = new MutationObserver(() => lucide.createIcons());
        observer.observe(document.getElementById('root'), { childList: true, subtree: true });
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
