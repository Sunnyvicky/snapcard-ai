<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapCard AI - æ™ºæ…§è¾¨è­˜ç©©å®šç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes scan {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(220px); opacity: 0; }
        }
        .scan-line { animation: scan 2s linear infinite; background: linear-gradient(to bottom, transparent, #3b82f6); height: 3px; width: 100%; }
        body { background-color: #f8fafc; color: #1e293b; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        video { object-fit: cover; width: 100%; height: 100%; border-radius: 1.5rem; background: #000; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // API é‡‘é‘°ç”±åŸ·è¡Œç’°å¢ƒè‡ªå‹•æ³¨å…¥
        const apiKey = ""; 

        function App() {
            const [status, setStatus] = useState("æº–å‚™å°±ç·’");
            const [isScanning, setIsScanning] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [resultData, setResultData] = useState(null);
            const [error, setError] = useState(null);

            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            // å¼·åŒ–ç‰ˆï¼šå•Ÿå‹•ç›¸æ©Ÿ
            const startCamera = async () => {
                setStatus("æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...");
                setError(null);
                setResultData(null);
                
                try {
                    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error("æ‚¨çš„ç€è¦½å™¨ç‰ˆæœ¬éèˆŠï¼Œä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½ã€‚");
                    }

                    const constraints = { 
                        video: { 
                            facingMode: { ideal: "environment" },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        // iOS å¿…é ˆåœ¨å–å¾—ä¸²æµå¾Œç«‹å³å‘¼å« play()
                        try {
                            await videoRef.current.play();
                            setIsScanning(true);
                            setStatus("è«‹å°æº–åç‰‡");
                        } catch (playError) {
                            console.error("Video play error:", playError);
                            throw new Error("ç„¡æ³•å•Ÿå‹•é è¦½ç•«é¢ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ã€‚");
                        }
                    }
                } catch (err) {
                    console.error("Camera access error:", err);
                    let msg = "ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—";
                    if (err.name === 'NotAllowedError') msg = "è«‹å…è¨±ç›¸æ©Ÿå­˜å–æ¬Šé™æ‰èƒ½æƒæåç‰‡ã€‚";
                    else if (err.name === 'NotFoundError') msg = "æ‰¾ä¸åˆ°å¯ç”¨çš„æ”å½±é¡é ­ã€‚";
                    else msg = err.message;
                    
                    setError(msg);
                    setStatus("å¤±æ•—");
                }
            };

            // æ‹ç…§
            const takePhoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (video && canvas) {
                    const ctx = canvas.getContext('2d');
                    // ç¢ºä¿è§£æåº¦åŒ¹é…
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/png');
                    setCapturedImage(dataUrl);
                    setIsScanning(false);
                    
                    // åœæ­¢æ‰€æœ‰è»Œé“ä»¥é‡‹æ”¾ç¡¬é«”
                    const stream = video.srcObject;
                    if (stream) {
                        stream.getTracks().forEach(t => t.stop());
                    }
                }
            };

            // å‘¼å« Gemini AI (å¸¶æœ‰é‡è©¦é‚è¼¯èˆ‡å¿«å–æ¸…ç†)
            const analyzeImage = async (base64Data) => {
                setIsProcessing(true);
                setStatus("AI æ­£åœ¨é–±è®€...");
                setError(null);
                
                const prompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åç‰‡ç§˜æ›¸ã€‚è«‹åˆ†æé€™å¼µåç‰‡åœ–ç‰‡ï¼Œä¸¦ä»¥ç¹é«”ä¸­æ–‡å›å‚³ JSON æ ¼å¼è³‡è¨Šã€‚æ¬„ä½åŒ…å«ï¼šname (å§“å), jobTitle (è·ç¨±), company (å…¬å¸åç¨±), phone (é›»è©±), email (é›»å­éƒµä»¶), address (åœ°å€)ã€‚å¦‚æœæ‰¾ä¸åˆ°è©²è³‡è¨Šï¼Œè«‹å›å‚³ç©ºå­—ä¸²ã€‚åªå›å‚³ JSON ç‰©ä»¶ï¼Œä¸è¦æœ‰é¡å¤–æè¿°ã€‚";
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/png", data: base64Data.split(',')[1] } }
                        ]
                    }]
                };

                const fetchWithRetry = async (url, options, retries = 5, delay = 1000) => {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                        return await response.json();
                    } catch (err) {
                        if (retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return fetchWithRetry(url, options, retries - 1, delay * 2);
                        }
                        throw err;
                    }
                };

                try {
                    const result = await fetchWithRetry(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload)
                        }
                    );

                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("AI æœªèƒ½è¾¨è­˜å…§å®¹");
                    
                    const jsonString = text.replace(/```json/g, "").replace(/```/g, "").trim();
                    const parsedData = JSON.parse(jsonString);
                    setResultData(parsedData);
                    setStatus("è¾¨è­˜æˆåŠŸ");
                } catch (err) {
                    console.error("AI Error:", err);
                    setError("è¾¨è­˜å‡ºéŒ¯ï¼Œè«‹ç¢ºèªç…§ç‰‡ä¸­åç‰‡æ–‡å­—æ˜¯å¦æ¸…æ™°ï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚");
                    setStatus("è¾¨è­˜å‡ºéŒ¯");
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div className="max-w-md mx-auto h-screen bg-gray-50 flex flex-col font-sans relative">
                    {/* Header */}
                    <header className="p-6 pt-12 bg-white flex justify-between items-center shadow-sm z-10">
                        <div>
                            <h1 className="text-xl font-black text-blue-600 tracking-tight">SnapCard AI</h1>
                            <div className="flex items-center gap-1 mt-1">
                                <div className={`w-1.5 h-1.5 rounded-full ${status === "è«‹å°æº–åç‰‡" ? "bg-green-500 animate-pulse" : "bg-gray-300"}`}></div>
                                <p className="text-[9px] text-gray-400 font-mono uppercase tracking-widest font-bold">{status}</p>
                            </div>
                        </div>
                        <button onClick={() => window.location.reload()} className="p-2 text-gray-300 hover:text-gray-600">
                            <i data-lucide="rotate-cw" className="w-5 h-5"></i>
                        </button>
                    </header>

                    <main className="flex-1 p-6 flex flex-col overflow-y-auto">
                        {/* ç‹€æ…‹1ï¼šèµ·å§‹ç•«é¢ */}
                        {!isScanning && !capturedImage && !resultData && (
                            <div className="flex-1 flex flex-col items-center justify-center text-center">
                                <div className="w-28 h-28 bg-blue-50 rounded-[2.5rem] flex items-center justify-center text-blue-600 mb-8 shadow-inner relative">
                                    <i data-lucide="camera" className="w-12 h-12"></i>
                                    <div className="absolute -top-1 -right-1 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center border-4 border-white">
                                        <i data-lucide="plus" className="w-3 h-3"></i>
                                    </div>
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-3">æ•¸ä½åŒ–æ‚¨çš„äººè„ˆ</h2>
                                <p className="text-sm text-gray-400 mb-10 leading-relaxed px-10">
                                    ç°¡å–®æ‹æ”åç‰‡ï¼ŒAI å°‡è‡ªå‹•ç‚ºæ‚¨æå–è¯çµ¡è³‡è¨Šä¸¦åˆ†é¡ã€‚
                                </p>
                                <button 
                                    onClick={startCamera}
                                    className="w-full bg-blue-600 text-white py-5 rounded-[1.5rem] font-bold shadow-xl shadow-blue-100 active:scale-[0.97] transition-all"
                                >
                                    ç«‹å³é–‹å§‹æƒæ
                                </button>
                            </div>
                        )}

                        {/* ç‹€æ…‹2ï¼šç›¸æ©Ÿç•«é¢ */}
                        {isScanning && (
                            <div className="flex-1 flex flex-col gap-8 animate-in fade-in duration-500">
                                <div className="relative aspect-[3/4] rounded-[2.5rem] overflow-hidden bg-black shadow-2xl border-4 border-white">
                                    <video ref={videoRef} playsInline muted autoPlay />
                                    <div className="absolute inset-0 flex items-center justify-center p-6">
                                        <div className="w-full aspect-[1.6/1] border-2 border-blue-400/50 rounded-2xl relative shadow-[0_0_0_1000px_rgba(0,0,0,0.6)]">
                                            <div className="scan-line absolute top-0"></div>
                                        </div>
                                    </div>
                                    <div className="absolute bottom-6 left-0 w-full text-center">
                                        <span className="bg-black/40 backdrop-blur-md text-white/90 text-[10px] px-3 py-1.5 rounded-full font-bold uppercase tracking-widest">
                                            è‡ªå‹•åµæ¸¬ä¸­...
                                        </span>
                                    </div>
                                </div>
                                <div className="flex justify-center">
                                    <button 
                                        onClick={takePhoto}
                                        className="w-20 h-20 rounded-full border-[6px] border-white bg-white/5 p-1 active:scale-90 transition-transform shadow-2xl relative"
                                    >
                                        <div className="w-full h-full bg-white rounded-full"></div>
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* ç‹€æ…‹3ï¼šç…§ç‰‡é è¦½ */}
                        {capturedImage && !resultData && (
                            <div className="flex-1 flex flex-col gap-6 animate-in zoom-in-95 duration-300">
                                <div className="relative aspect-[3/4] rounded-[2.5rem] overflow-hidden bg-white shadow-xl flex items-center justify-center border-4 border-white">
                                    <img src={capturedImage} className="max-h-full object-contain" alt="Captured" />
                                    {isProcessing && (
                                        <div className="absolute inset-0 bg-blue-600/70 backdrop-blur-md flex flex-col items-center justify-center text-white p-8 text-center">
                                            <div className="w-14 h-14 border-4 border-white/20 border-t-white rounded-full animate-spin mb-6"></div>
                                            <p className="font-black text-xl tracking-tight">AI æ™ºæ…§è¾¨è­˜ä¸­</p>
                                            <p className="text-xs opacity-70 mt-2 font-medium">æ­£åœ¨ç‚ºæ‚¨æ•´ç†åç‰‡è³‡è¨Š...</p>
                                        </div>
                                    )}
                                </div>
                                {!isProcessing && (
                                    <div className="flex gap-4">
                                        <button 
                                            onClick={() => { setCapturedImage(null); startCamera(); }}
                                            className="flex-1 bg-white text-gray-500 py-4 rounded-2xl font-bold border border-gray-100 active:bg-gray-50 shadow-sm"
                                        >
                                            é‡æ‹
                                        </button>
                                        <button 
                                            onClick={() => analyzeImage(capturedImage)}
                                            className="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-100 active:scale-[0.98]"
                                        >
                                            é–‹å§‹è¾¨è­˜
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* ç‹€æ…‹4ï¼šè¾¨è­˜çµæœ */}
                        {resultData && (
                            <div className="flex-1 flex flex-col gap-5 animate-in fade-in slide-in-from-bottom-8 duration-700 pb-12">
                                <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-gray-100">
                                    <div className="flex items-center gap-5 mb-8">
                                        <div className="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-700 rounded-3xl flex items-center justify-center text-white font-black text-3xl shadow-xl shadow-blue-100">
                                            {resultData.name?.[0] || "ğŸ‘¤"}
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-2xl font-black text-gray-900 leading-none mb-1">{resultData.name || "æœªçŸ¥åç¨±"}</h3>
                                            <p className="text-sm text-blue-600 font-bold uppercase tracking-wider">{resultData.jobTitle || "è·ä½æœªè¼‰"}</p>
                                        </div>
                                    </div>

                                    <div className="space-y-6">
                                        {[
                                            { icon: "building", label: "å…¬å¸å–®ä½", value: resultData.company },
                                            { icon: "smartphone", label: "è¯çµ¡é›»è©±", value: resultData.phone },
                                            { icon: "at-sign", label: "é›»å­éƒµä»¶", value: resultData.email },
                                            { icon: "map-pinned", label: "è¾¦å…¬åœ°å€", value: resultData.address }
                                        ].map((item, idx) => (
                                            <div key={idx} className="flex items-start gap-4">
                                                <div className="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center text-gray-400 shrink-0">
                                                    <i data-lucide={item.icon} className="w-5 h-5"></i>
                                                </div>
                                                <div className="flex-1 pt-1">
                                                    <p className="text-[10px] text-gray-300 uppercase font-black tracking-widest leading-none mb-1">{item.label}</p>
                                                    <p className="text-[15px] font-bold text-gray-700 leading-snug">{item.value || "---"}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={() => alert("å„²å­˜åŠŸèƒ½é–‹ç™¼ä¸­ï¼")}
                                    className="w-full bg-green-600 text-white py-5 rounded-[1.5rem] font-bold shadow-xl shadow-green-100 mt-2 flex items-center justify-center gap-3 active:scale-[0.97]"
                                >
                                    <i data-lucide="save" className="w-5 h-5"></i>
                                    ç¢ºèªä¸¦å„²å­˜åç‰‡
                                </button>
                                <button 
                                    onClick={() => { setResultData(null); setCapturedImage(null); startCamera(); }}
                                    className="w-full text-gray-300 py-2 text-xs font-black uppercase tracking-[0.2em]"
                                >
                                    æ¨æ£„ä¸¦é‡æ‹
                                </button>
                            </div>
                        )}
                        
                        {error && (
                            <div className="mt-4 p-5 bg-red-50 text-red-600 rounded-3xl text-xs flex items-center gap-4 border border-red-100 animate-bounce">
                                <i data-lucide="shield-alert" className="w-6 h-6 shrink-0 opacity-50"></i>
                                <span className="font-bold leading-relaxed">{error}</span>
                            </div>
                        )}
                    </main>

                    <canvas ref={canvasRef} className="hidden"></canvas>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // è§€å¯Ÿ DOM è®ŠåŒ–ä»¥é‡æ–°åˆå§‹åŒ–åœ–ç¤º
        const observer = new MutationObserver(() => lucide.createIcons());
        observer.observe(document.getElementById('root'), { childList: true, subtree: true });
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
