<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapCard AI - å°ˆæ¥­äººè„ˆç®¡å®¶</title>
    
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SnapCard">
    <meta name="theme-color" content="#1e3a8a">
    
    <!-- App Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%231e3a8a'/%3E%3Cstop offset='1' stop-color='%230f172a'/%3E%3C/linearGradient%3E%3Cfilter id='shadow'%3E%3CfeDropShadow dx='0' dy='8' stdDeviation='12' flood-opacity='0.25'/%3E%3C/filter%3E%3C/defs%3E%3Crect width='512' height='512' rx='120' fill='url(%23bg)'/%3E%3C!-- åç‰‡æœ¬é«” --%3E%3Cg filter='url(%23shadow)'%3E%3Crect x='86' y='156' width='340' height='200' rx='20' fill='white'/%3E%3Crect x='86' y='190' width='340' height='8' fill='%23f59e0b'/%3E%3Ccircle cx='160' cy='256' r='35' fill='%23e2e8f0'/%3E%3Crect x='220' y='236' width='140' height='16' rx='4' fill='%2394a3b8'/%3E%3Crect x='220' y='266' width='100' height='12' rx='3' fill='%23cbd5e1'/%3E%3C/g%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%231e3a8a'/%3E%3Cstop offset='1' stop-color='%230f172a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='120' fill='url(%23bg)'/%3E%3Crect x='86' y='156' width='340' height='200' rx='20' fill='white'/%3E%3Crect x='86' y='190' width='340' height='8' fill='%23f59e0b'/%3E%3Ccircle cx='160' cy='256' r='35' fill='%23e2e8f0'/%3E%3Crect x='220' y='236' width='140' height='16' rx='4' fill='%2394a3b8'/%3E%3Crect x='220' y='266' width='100' height='12' rx='3' fill='%23cbd5e1'/%3E%3C/svg%3E">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f8fafc; color: #1e293b; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        video {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 10; transform: scaleX(1);
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .scan-line {
            position: absolute; left: 0; width: 100%; height: 2px;
            background: #f97316; box-shadow: 0 0 10px #f97316;
            animation: scan 2s linear infinite;
        }
        .splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8fafc; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="splash-screen">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #3b82f6 0%, #0f172a 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.4);">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 512 512" fill="none">
                    <rect x="96" y="156" width="320" height="200" rx="24" fill="white"/>
                    <rect x="96" y="190" width="320" height="16" fill="#f97316"/>
                    <circle cx="170" cy="256" r="30" fill="#cbd5e1"/>
                    <rect x="230" y="240" width="120" height="16" rx="4" fill="#94a3b8"/>
                    <rect x="230" y="270" width="80" height="12" rx="3" fill="#e2e8f0"/>
                </svg>
            </div>
            <h1 style="font-size: 20px; font-weight: 900; color: #1e293b; font-family: sans-serif; letter-spacing: -0.5px;">SNAPCARD AI</h1>
            <p style="font-size: 14px; color: #64748b; font-family: sans-serif; margin-top: 8px; letter-spacing: 1px;">äººè„ˆï¼Œæ˜¯æœ€å¥½çš„è³‡ç”¢</p>
        </div>
    </div>

    <!-- éŒ¯èª¤æ””æˆª -->
    <script>
        window.onerror = function(message) {
            const root = document.getElementById('root');
            if (root) root.innerHTML = '<div style="padding:20px;text-align:center;color:red;margin-top:50px;"><h3>å•Ÿå‹•ç™¼ç”ŸéŒ¯èª¤</h3><p>'+message+'</p><button onclick="localStorage.clear();location.reload()" style="padding:10px;margin-top:10px;">é‡ç½® App</button></div>';
        };
    </script>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo, Component } = React;

        // --- å®‰å…¨çš„ LocalStorage ---
        const safeLocalStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch (e) { return null; } },
            setItem: (key, value) => { try { localStorage.setItem(key, value); } catch (e) { } },
            removeItem: (key) => { try { localStorage.removeItem(key); } catch (e) { } }
        };

        // --- IndexedDB ---
        const DB_NAME = 'SnapCardDB';
        const STORE_NAME = 'cards';
        const DB_VERSION = 1;
        const dbUtils = {
            open: () => new Promise((resolve, reject) => {
                try {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    };
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                } catch(e) { reject(e); }
            }),
            getAll: async () => {
                const db = await dbUtils.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readonly');
                    const req = tx.objectStore(STORE_NAME).getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            put: async (card) => {
                const db = await dbUtils.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const req = tx.objectStore(STORE_NAME).put(card);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            delete: async (id) => {
                const db = await dbUtils.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const req = tx.objectStore(STORE_NAME).delete(id);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            },
            clear: async () => {
                const db = await dbUtils.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const req = tx.objectStore(STORE_NAME).clear();
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            }
        };

        // --- Error Boundary ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) {
                    return <div className="h-screen flex items-center justify-center p-6 text-center text-red-600">ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ã€‚</div>;
                }
                return this.props.children;
            }
        }

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current || !window.lucide) return;
                ref.current.innerHTML = '';
                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                ref.current.appendChild(i);
                window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className } });
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center' }}></span>;
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) return reject("ç„¡æª”æ¡ˆ");
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    const canvas = document.createElement('canvas');
                    const MAX_SIZE = 800; 
                    let width = img.width, height = img.height;
                    if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } }
                    else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                };
                img.onerror = reject;
            });
        };

        const CameraScanner = ({ onCapture, onCancel }) => {
            const videoRef = useRef(null);
            const [error, setError] = useState(null);
            useEffect(() => {
                let stream = null;
                const startCamera = async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false });
                        if (videoRef.current) { videoRef.current.srcObject = stream; videoRef.current.play().catch(e => console.error("Play error", e)); }
                    } catch (e) { setError("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: " + e.message); }
                };
                startCamera();
                return () => { if (stream) stream.getTracks().forEach(t => t.stop()); };
            }, []);
            
            const capture = () => {
                if (!videoRef.current) return;
                const video = videoRef.current;
                const canvas = document.createElement("canvas");
                const videoRatio = video.videoWidth / video.videoHeight;
                const displayRatio = video.clientWidth / video.clientHeight;
                let sx = 0, sy = 0, sWidth = video.videoWidth, sHeight = video.videoHeight;
                if (videoRatio > displayRatio) { sWidth = video.videoHeight * displayRatio; sx = (video.videoWidth - sWidth) / 2; }
                else { sHeight = video.videoWidth / displayRatio; sy = (video.videoHeight - sHeight) / 2; }
                const frameWidthInSource = sWidth * 0.75, frameHeightInSource = frameWidthInSource / 1.6;
                const frameX = sx + (sWidth - frameWidthInSource) / 2, frameY = sy + (sHeight - frameHeightInSource) / 2;
                const MAX_DIM = 1000;
                let destWidth = frameWidthInSource, destHeight = frameHeightInSource;
                if (destWidth > MAX_DIM || destHeight > MAX_DIM) { const scale = Math.min(MAX_DIM / destWidth, MAX_DIM / destHeight); destWidth *= scale; destHeight *= scale; }
                canvas.width = destWidth; canvas.height = destHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, frameX, frameY, frameWidthInSource, frameHeightInSource, 0, 0, destWidth, destHeight);
                onCapture(canvas.toDataURL("image/jpeg", 0.7));
            };

            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col">
                    <div className="flex-1 relative overflow-hidden">
                        <video ref={videoRef} playsInline muted autoPlay className="w-full h-full object-cover" />
                        {error && <div className="absolute inset-0 flex items-center justify-center text-white bg-black/80">{error}</div>}
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-20">
                            <div className="w-3/4 aspect-[1.6/1] border-2 border-blue-500 rounded-xl relative shadow-[0_0_0_999px_rgba(0,0,0,0.5)] overflow-hidden">
                                <div className="scan-line"></div>
                                <div className="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-blue-500 -mt-1 -ml-1"></div>
                                <div className="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-blue-500 -mt-1 -mr-1"></div>
                                <div className="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-blue-500 -mb-1 -ml-1"></div>
                                <div className="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-blue-500 -mb-1 -mr-1"></div>
                            </div>
                        </div>
                        <div className="absolute bottom-32 w-full text-center z-20"><span className="px-4 py-2 bg-black/50 text-white text-xs rounded-full">è«‹å°‡åç‰‡æ”¾å…¥æ¡†å…§</span></div>
                    </div>
                    <div className="h-32 bg-black flex items-center justify-center gap-8 z-30">
                        <button onClick={onCancel} className="text-white font-bold p-4">å–æ¶ˆ</button>
                        <button onClick={capture} className="w-16 h-16 bg-white rounded-full border-4 border-gray-300 active:scale-95 transition-transform"></button>
                        <div className="w-12"></div>
                    </div>
                </div>
            );
        };

        function App() {
            const [showSplash, setShowSplash] = useState(true);
            const [view, setView] = useState("home");
            const [cards, setCards] = useState([]);
            const [isLoadingDB, setIsLoadingDB] = useState(true);
            const [capturedImage, setCapturedImage] = useState(null); 
            const [backImage, setBackImage] = useState(null); 
            const [currentAvatar, setCurrentAvatar] = useState(null);
            const [additionalImage, setAdditionalImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [resultData, setResultData] = useState({});
            const [currentCardId, setCurrentCardId] = useState(null);
            const [filterCategory, setFilterCategory] = useState("å…¨éƒ¨");
            const [apiKey, setApiKey] = useState(() => safeLocalStorage.getItem("snapcard_api_key") || "");
            const [error, setError] = useState(null);
            const [statusMsg, setStatusMsg] = useState("AI è¾¨è­˜ä¸­...");
            const [searchQuery, setSearchQuery] = useState(""); 
            const [testStatus, setTestStatus] = useState("idle"); 
            const [testMessage, setTestMessage] = useState("");

            useEffect(() => {
                const timer = setTimeout(() => setShowSplash(false), 2000);
                return () => clearTimeout(timer);
            }, []);

            useEffect(() => {
                const loadCards = async () => {
                    try {
                        setIsLoadingDB(true);
                        const dbCards = await dbUtils.getAll();
                        const hasMigrated = safeLocalStorage.getItem("snapcard_migrated");
                        const localCardsStr = safeLocalStorage.getItem("snapcard_cards");
                        if (localCardsStr && !hasMigrated) {
                            try {
                                const localCards = JSON.parse(localCardsStr);
                                if (localCards.length > 0) {
                                    for (const card of localCards) {
                                        if (!dbCards.find(c => c.id === card.id)) { await dbUtils.put(card); dbCards.push(card); }
                                    }
                                    safeLocalStorage.setItem("snapcard_migrated", "true");
                                }
                            } catch (e) { console.error("Migration error", e); }
                        }
                        setCards(dbCards.sort((a, b) => b.id - a.id));
                    } catch (err) { setError("è³‡æ–™åº«è®€å–å¤±æ•—"); } 
                    finally { setIsLoadingDB(false); }
                };
                loadCards();
            }, []);

            useEffect(() => {
                const timer = setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 50);
                return () => clearTimeout(timer);
            }, [view, cards.length, resultData, additionalImage, backImage, currentAvatar, filterCategory, showSplash, testStatus]);

            const startScanFlow = () => {
                if (!apiKey) { setView("settings"); return; }
                setView("scan");
            };

            const handleManualAdd = () => {
                setResultData({ category: "å·¥ä½œ" });
                setCapturedImage(null); setBackImage(null); setCurrentAvatar(null); setAdditionalImage(null); setCurrentCardId(null);
                setView("result");
            };

            const handleScanCapture = (base64) => {
                setCapturedImage(base64); setView("home"); analyze(base64);
            };

            const testConnection = async () => {
                if (!apiKey) { setTestStatus("error"); setTestMessage("è«‹å…ˆè¼¸å…¥ API Key"); return; }
                setTestStatus("testing"); setTestMessage("é€£ç·šæ¸¬è©¦ä¸­...");
                try {
                    const cleanKey = apiKey.trim();
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${cleanKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    const data = await res.json();
                    if (!res.ok) { const msg = data.error?.message || res.statusText || "Unknown Error"; throw new Error(`${res.status}: ${msg}`); }
                    setTestStatus("success"); setTestMessage("API Key æœ‰æ•ˆï¼é€£ç·šæˆåŠŸã€‚");
                } catch (e) { setTestStatus("error"); setTestMessage(`æ¸¬è©¦å¤±æ•—: ${e.message}`); }
            };

            const analyze = async (base64) => {
                setIsProcessing(true); setError(null);
                const models = ["gemini-1.5-flash", "gemini-2.0-flash-exp", "gemini-1.5-flash-8b", "gemini-1.5-pro"];
                let imageParts = [{ inlineData: { mimeType: "image/jpeg", data: base64.split(',')[1] } }];
                const promptText = `åˆ†æåç‰‡å›å‚³JSON:{"name":"","jobTitle":"","company":"","mobile":"","tel":"","fax":"","email":"","address":"","category":"å·¥ä½œ","note":""}ã€‚
                é‡é»è¦å‰‡ï¼š1. è«‹å°‡é›»è©±å€åˆ†ç‚º mobile(æ‰‹æ©Ÿ), tel(å¸‚è©±), fax(å‚³çœŸ)ã€‚ 2. companyæ¬„ä½è«‹åˆä½µä¸­æ–‡åŠè‹±æ–‡åç¨±ã€‚ 3. categoryå¾[å·¥ä½œ,å®¶äºº,åŒå­¸,æœ‹å‹]é¸ã€‚ 4. noteæ¬„ä½ä¿ç•™ç©ºç™½ã€‚ ç„¡Markdownã€‚`;
                let lastErrorMessage = "æœªçŸ¥éŒ¯èª¤";

                const tryModel = async (index) => {
                    if (index >= models.length) { throw new Error(`åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯ã€‚\næœ€å¾ŒéŒ¯èª¤: ${lastErrorMessage}`); }
                    const model = models[index];
                    setStatusMsg(`AI è¾¨è­˜ä¸­... (å˜—è©¦ ${model})`);
                    try {
                        const cleanKey = apiKey.trim();
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${cleanKey}`, {
                            method: "POST", headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ contents: [{ parts: [{ text: promptText }, ...imageParts] }] })
                        });
                        if (!res.ok) {
                            const errJson = await res.json().catch(() => ({}));
                            const msg = errJson.error?.message || errJson.error?.status || res.statusText;
                            lastErrorMessage = `${res.status} ${msg}`;
                            if (res.status === 400 && (msg.includes("API key") || msg.includes("API_KEY") || msg.includes("INVALID_ARGUMENT"))) {
                                throw new Error("API Key ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚");
                            }
                            console.warn(`Model ${model} failed (${res.status}): ${msg}`);
                            await new Promise(r => setTimeout(r, 1000));
                            return await tryModel(index + 1);
                        }
                        return await res.json();
                    } catch (e) {
                        if (e.message.includes("API Key")) throw e;
                        lastErrorMessage = e.message;
                        return await tryModel(index + 1);
                    }
                };

                try {
                    const json = await tryModel(0);
                    let text = json.candidates[0].content.parts[0].text;
                    text = text.replace(/```json|```/g, '').trim();
                    const start = text.indexOf('{'), end = text.lastIndexOf('}');
                    const data = JSON.parse(text.substring(start, end + 1));
                    setResultData(data || { category: "å·¥ä½œ" });
                    setBackImage(null); setAdditionalImage(null); setCurrentAvatar(null); setCurrentCardId(null);
                    setView("result");
                } catch (e) { setError(e.message); setView("home"); } 
                finally { setIsProcessing(false); }
            };

            const saveCard = async () => {
                const newData = { id: currentCardId || Date.now(), ...resultData, image: capturedImage, backImage: backImage, avatar: currentAvatar, additionalImage: additionalImage, category: resultData.category || "å·¥ä½œ" };
                try {
                    await dbUtils.put(newData);
                    if (currentCardId) setCards(prev => prev.map(c => c.id === currentCardId ? newData : c));
                    else setCards(prev => [newData, ...prev]);
                    setView("home");
                } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
            };

            const handleDeleteCard = async (id, e) => {
                e.stopPropagation();
                if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å¼µåç‰‡å—ï¼Ÿ")) {
                    try { await dbUtils.delete(id); setCards(prev => prev.filter(c => c.id !== id)); } catch (e) { alert("åˆªé™¤å¤±æ•—"); }
                }
            };

            const handleImageUpload = async (e, setter) => {
                if (e.target.files[0]) {
                    try { const base64 = await compressImage(e.target.files[0]); setter(base64); } catch(err) { alert("åœ–ç‰‡è™•ç†å¤±æ•—"); }
                }
            };

            const viewSavedCard = (card) => {
                const data = {...card};
                if (data.phone && !data.mobile && !data.tel) { if (data.phone.startsWith("09")) data.mobile = data.phone; else data.tel = data.phone; }
                setResultData(data); setCapturedImage(card.image); setBackImage(card.backImage || null); setCurrentAvatar(card.avatar); setAdditionalImage(card.additionalImage || null); setCurrentCardId(card.id);
                setView("result");
            };

            const filteredCards = useMemo(() => {
                let result = filterCategory === "å…¨éƒ¨" ? cards : cards.filter(c => c.category === filterCategory);
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    result = result.filter(c => (c.name && c.name.toLowerCase().includes(q)) || (c.company && c.company.toLowerCase().includes(q)));
                }
                return result.sort((a, b) => {
                    const companyA = (a.company || "").toLowerCase();
                    const companyB = (b.company || "").toLowerCase();
                    return companyA.localeCompare(companyB, "zh-Hant");
                });
            }, [cards, filterCategory, searchQuery]);

            const exportData = () => {
                if (cards.length === 0) { alert("ç„¡è³‡æ–™å¯åŒ¯å‡º"); return; }
                const dataStr = JSON.stringify(cards, null, 2);
                const blob = new Blob([dataStr], { type: "application/octet-stream" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url; link.download = `snapcard_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link); link.click();
                setTimeout(() => { document.body.removeChild(link); URL.revokeObjectURL(url); }, 100);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.readAsText(file, "UTF-8");
                reader.onload = async e => {
                    try {
                        const importedCards = JSON.parse(e.target.result);
                        if (Array.isArray(importedCards)) {
                            if (confirm(`åŒ¯å…¥ ${importedCards.length} ç­†è³‡æ–™ï¼Ÿ`)) {
                                for (const card of importedCards) await dbUtils.put(card);
                                const allCards = await dbUtils.getAll();
                                setCards(allCards.sort((a, b) => b.id - a.id));
                                alert("åŒ¯å…¥æˆåŠŸï¼");
                            }
                        } else alert("æ ¼å¼éŒ¯èª¤");
                    } catch (err) { alert("è®€å–å¤±æ•—"); }
                };
                e.target.value = '';
            };

            const clearAllData = async () => {
                if(confirm("è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ã€‚ç¢ºå®šå—ï¼Ÿ")) {
                    try { await dbUtils.clear(); setCards([]); safeLocalStorage.removeItem("snapcard_cards"); alert("å·²æ¸…ç©º"); } catch (e) { alert("æ¸…é™¤å¤±æ•—"); }
                }
            };

            if (showSplash) {
                return (
                    <div className="fixed inset-0 bg-[#f8fafc] z-[9999] flex flex-col items-center justify-center">
                        <div style={{ width: '64px', height: '64px', background: 'linear-gradient(135deg, #3b82f6 0%, #0f172a 100%)', borderRadius: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '16px', boxShadow: '0 10px 25px -5px rgba(15, 23, 42, 0.4)' }}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 512 512" fill="none">
                                <rect x="96" y="156" width="320" height="200" rx="24" fill="white"/>
                                <rect x="136" y="190" width="140" height="32" rx="8" fill="#cbd5e1"/>
                                <rect x="136" y="250" width="240" height="20" rx="6" fill="#e2e8f0"/>
                                <rect x="136" y="290" width="180" height="20" rx="6" fill="#e2e8f0"/>
                                <path d="M64 256h384" stroke="#f59e0b" strokeWidth="32" strokeLinecap="round"/>
                            </svg>
                        </div>
                        <h1 style={{ fontSize: '20px', fontWeight: '900', color: '#1e293b', fontFamily: 'sans-serif', letterSpacing: '-0.5px' }}>SNAPCARD AI</h1>
                        <p style={{ fontSize: '14px', color: '#64748b', fontFamily: 'sans-serif', marginTop: '8px', letterSpacing: '1px' }}>äººè„ˆï¼Œæ˜¯æœ€å¥½çš„è³‡ç”¢</p>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto h-screen bg-gray-50 flex flex-col font-sans overflow-hidden border-x border-gray-200">
                    <header className="px-6 pt-12 pb-4 bg-white shadow-sm flex justify-between items-center z-10">
                        <h1 className="text-xl font-black text-blue-600 tracking-tighter">SNAPCARD</h1>
                        <button onClick={() => setView("settings")} className="text-gray-400">
                            <Icon name="settings" />
                        </button>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 relative">
                        {error && <div className="bg-red-100 text-red-600 p-3 rounded-lg mb-4 text-xs font-bold whitespace-pre-wrap">{error}</div>}

                        {view === "home" && (
                            <div className="space-y-4">
                                {!apiKey && (
                                    <div onClick={() => setView("settings")} className="bg-blue-50 p-4 rounded-xl text-blue-600 text-center text-sm font-bold cursor-pointer border border-blue-100 animate-pulse">
                                        ğŸ‘‰ è«‹å…ˆè¨­å®š API Key
                                    </div>
                                )}
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icon name="search" size={16} /></div>
                                    <input type="text" placeholder="æœå°‹å§“åæˆ–å…¬å¸..." className="w-full bg-white border border-gray-100 rounded-xl pl-10 pr-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 shadow-sm" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                                    {searchQuery && <button onClick={() => setSearchQuery("")} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 p-1"><Icon name="x" size={14} /></button>}
                                </div>
                                <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                                    {["å…¨éƒ¨", "å·¥ä½œ", "å®¶äºº", "åŒå­¸", "æœ‹å‹"].map(cat => (
                                        <button key={cat} onClick={() => setFilterCategory(cat)} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${filterCategory === cat ? "bg-blue-600 text-white shadow-sm" : "bg-white text-gray-500 border border-gray-100"}`}>{cat}</button>
                                    ))}
                                </div>
                                {filteredCards.length === 0 ? (
                                    <div className="text-center py-20 text-gray-400 text-sm">{cards.length === 0 ? "æš«ç„¡åç‰‡" : "æ‰¾ä¸åˆ°ç¬¦åˆçš„åç‰‡"}</div>
                                ) : (
                                    filteredCards.map(c => (
                                        <div key={c.id} onClick={() => viewSavedCard(c)} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center gap-4 active:scale-[0.98] transition-transform">
                                            {c.avatar ? <img src={c.avatar} className="w-12 h-12 rounded-full object-cover bg-gray-100 border border-gray-100" /> : <div className="w-12 h-12 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center font-bold text-lg">{c.name?.[0] || "?"}</div>}
                                            <div className="flex-1 min-w-0">
                                                <div className="font-bold text-gray-800 text-base truncate">{c.name || "æœªå‘½å"}</div>
                                                <div className="text-xs text-gray-500 truncate">{c.company || c.jobTitle || "ç„¡å…¬å¸è³‡è¨Š"}</div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={(e) => handleDeleteCard(c.id, e)} className="p-2 text-gray-300 hover:text-red-500"><Icon name="trash-2" size={16} /></button>
                                            </div>
                                        </div>
                                    ))
                                )}
                                <div className="h-24"></div>
                            </div>
                        )}

                        {view === "settings" && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    <h3 className="font-bold text-lg mb-4 text-gray-800 flex items-center gap-2"><Icon name="key" className="text-blue-500" /> API è¨­å®š</h3>
                                    <p className="text-xs text-gray-500 mb-2">è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key</p>
                                    <div style={{opacity: 0, position: 'absolute', top: 0, left: 0, height: 0, width: 0, zIndex: -1}}>
                                        <input type="text" name="fake_username" tabIndex="-1" />
                                        <input type="password" name="fake_password" tabIndex="-1" />
                                    </div>
                                    <input type="password" autoComplete="new-password" name="gemini_api_key_field" value={apiKey} onChange={(e) => { setApiKey(e.target.value); safeLocalStorage.setItem("snapcard_api_key", e.target.value); }} className="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm mb-3 focus:ring-2 focus:ring-blue-100 focus:outline-none" placeholder="AIzaSy..." />
                                    <div className="flex gap-2 mb-2">
                                        <button onClick={testConnection} disabled={testStatus === "testing"} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-colors ${testStatus === "success" ? "bg-green-100 text-green-700" : testStatus === "error" ? "bg-red-100 text-red-700" : "bg-blue-100 text-blue-700"}`}>{testStatus === "testing" ? "æ¸¬è©¦ä¸­..." : testStatus === "success" ? "æ¸¬è©¦æˆåŠŸ" : "æ¸¬è©¦é€£ç·š"}</button>
                                        <button onClick={() => window.open("https://aistudio.google.com/app/apikey", "_blank")} className="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg text-sm font-bold hover:bg-gray-200 transition-colors">å–å¾— Key</button>
                                    </div>
                                    {testMessage && <div className={`text-xs p-2 rounded ${testStatus === 'success' ? 'text-green-600 bg-green-50' : testStatus === 'error' ? 'text-red-600 bg-red-50' : 'text-gray-500'}`}>{testMessage}</div>}
                                </div>
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    <h3 className="font-bold text-lg mb-4 text-gray-800 flex items-center gap-2"><Icon name="database" className="text-purple-500" /> è³‡æ–™ç®¡ç†</h3>
                                    <div className="space-y-3">
                                        <button onClick={exportData} className="w-full flex items-center justify-between p-3 bg-gray-50 rounded-xl text-gray-700 font-medium hover:bg-gray-100 transition-colors"><span>åŒ¯å‡ºå‚™ä»½ (JSON)</span><Icon name="upload" size={18} /></button>
                                        <label className="w-full flex items-center justify-between p-3 bg-gray-50 rounded-xl text-gray-700 font-medium hover:bg-gray-100 transition-colors cursor-pointer"><span>åŒ¯å…¥å‚™ä»½</span><Icon name="download" size={18} /><input type="file" accept=".json" onChange={importData} className="hidden" /></label>
                                        <button onClick={clearAllData} className="w-full flex items-center justify-between p-3 bg-red-50 text-red-600 rounded-xl font-medium hover:bg-red-100 transition-colors"><span>æ¸…ç©ºæ‰€æœ‰è³‡æ–™</span><Icon name="trash" size={18} /></button>
                                    </div>
                                </div>
                                <div className="text-center text-xs text-gray-400 mt-8">AA Version Stable â€¢ Local Storage Only</div>
                                <button onClick={() => setView("home")} className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold mt-4">è¿”å›</button>
                            </div>
                        )}

                        {view === "scan" && <CameraScanner onCapture={handleScanCapture} onCancel={() => setView("home")} />}

                        {view === "result" && (
                            <div className="bg-white min-h-full rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
                                <div className="bg-gray-100 relative group">
                                    {capturedImage ? <img src={capturedImage} className="w-full object-contain max-h-64" /> : <div className="h-40 flex items-center justify-center text-gray-400">ç„¡åç‰‡å½±åƒ</div>}
                                    <button onClick={() => document.getElementById('retake-input').click()} className="absolute bottom-2 right-2 bg-black/50 text-white p-2 rounded-full backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="camera" size={16}/></button>
                                    <input id="retake-input" type="file" accept="image/*" className="hidden" onChange={(e)=>handleImageUpload(e, setCapturedImage)}/>
                                </div>
                                <div className="p-5 flex-1 space-y-4">
                                    <div className="flex gap-4">
                                        <div className="relative w-20 h-20 flex-shrink-0">
                                            {currentAvatar ? <img src={currentAvatar} className="w-20 h-20 rounded-xl object-cover border border-gray-200" /> : <div className="w-20 h-20 rounded-xl bg-gray-100 flex items-center justify-center text-gray-300"><Icon name="user" size={32} /></div>}
                                            <label className="absolute -bottom-2 -right-2 bg-white shadow-md p-1.5 rounded-full cursor-pointer border border-gray-100"><Icon name="edit-2" size={12} className="text-blue-500" /><input type="file" accept="image/*" className="hidden" onChange={(e)=>handleImageUpload(e, setCurrentAvatar)} /></label>
                                        </div>
                                        <div className="flex-1 space-y-2">
                                            <input type="text" value={resultData.name||""} onChange={(e)=>setResultData({...resultData, name:e.target.value})} placeholder="å§“å" className="w-full text-xl font-black bg-transparent border-b border-transparent focus:border-blue-500 focus:outline-none placeholder-gray-300" />
                                            <input type="text" value={resultData.jobTitle||""} onChange={(e)=>setResultData({...resultData, jobTitle:e.target.value})} placeholder="è·ç¨±" className="w-full text-sm text-gray-500 bg-transparent border-b border-transparent focus:border-blue-500 focus:outline-none placeholder-gray-300" />
                                        </div>
                                    </div>
                                    <div className="space-y-3 pt-2">
                                        {[
                                            { icon: "building", key: "company", placeholder: "å…¬å¸åç¨±" },
                                            { icon: "smartphone", key: "mobile", placeholder: "æ‰‹æ©Ÿè™Ÿç¢¼" },
                                            { icon: "phone", key: "tel", placeholder: "å…¬å¸é›»è©±" },
                                            { icon: "printer", key: "fax", placeholder: "å‚³çœŸ" },
                                            { icon: "mail", key: "email", placeholder: "Email" },
                                            { icon: "map-pin", key: "address", placeholder: "åœ°å€" },
                                        ].map(field => {
                                            const isActionable = (field.key === 'mobile' || field.key === 'tel' || field.key === 'email') && resultData[field.key];
                                            const href = field.key === 'email' ? `mailto:${resultData[field.key]}` : `tel:${resultData[field.key]}`;
                                            return (
                                                <div key={field.key} className="flex items-center gap-3 bg-gray-50 p-3 rounded-xl">
                                                    {isActionable ? <a href={href} className="text-blue-500 active:text-blue-700"><Icon name={field.icon} size={18} /></a> : <Icon name={field.icon} className="text-gray-400" size={18} />}
                                                    <input type="text" value={resultData[field.key]||""} onChange={(e)=>setResultData({...resultData, [field.key]:e.target.value})} placeholder={field.placeholder} className="flex-1 bg-transparent text-sm text-gray-700 focus:outline-none placeholder-gray-300" />
                                                </div>
                                            );
                                        })}
                                        <div className="flex gap-2 py-2">
                                            {["å·¥ä½œ", "å®¶äºº", "åŒå­¸", "æœ‹å‹"].map(c => (
                                                <button key={c} onClick={()=>setResultData({...resultData, category: c})} className={`flex-1 py-2 text-xs rounded-lg font-bold border ${resultData.category===c ? "bg-blue-50 border-blue-200 text-blue-600" : "border-gray-100 text-gray-400"}`}>{c}</button>
                                            ))}
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="relative aspect-video bg-gray-50 rounded-xl flex items-center justify-center border border-dashed border-gray-300 overflow-hidden cursor-pointer" onClick={()=>document.getElementById('back-upload').click()}>
                                                {backImage ? <img src={backImage} className="w-full h-full object-cover" /> : <div className="text-center text-xs text-gray-400"><Icon name="image" className="mx-auto mb-1"/>èƒŒé¢</div>}
                                                <input id="back-upload" type="file" accept="image/*" className="hidden" onChange={(e)=>handleImageUpload(e, setBackImage)} />
                                            </div>
                                            <div className="relative aspect-video bg-gray-50 rounded-xl flex items-center justify-center border border-dashed border-gray-300 overflow-hidden cursor-pointer" onClick={()=>document.getElementById('add-upload').click()}>
                                                {additionalImage ? <img src={additionalImage} className="w-full h-full object-cover" /> : <div className="text-center text-xs text-gray-400"><Icon name="plus" className="mx-auto mb-1"/>é™„ä»¶</div>}
                                                <input id="add-upload" type="file" accept="image/*" className="hidden" onChange={(e)=>handleImageUpload(e, setAdditionalImage)} />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-3 pt-4 pb-20">
                                        <button onClick={() => setView("home")} className="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-100">å–æ¶ˆ</button>
                                        <button onClick={saveCard} className="flex-1 py-3 rounded-xl font-bold text-white bg-blue-600 shadow-lg shadow-blue-200">å„²å­˜åç‰‡</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isProcessing && (
                            <div className="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
                                <div className="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                                <div className="text-blue-900 font-bold animate-pulse">{statusMsg}</div>
                                <div className="text-xs text-gray-400 mt-2">è«‹ç¨å€™ï¼Œæ­£åœ¨åˆ†æåç‰‡è³‡è¨Š...</div>
                            </div>
                        )}
                    </main>

                    {view === "home" && (
                        <div className="absolute bottom-6 left-0 w-full flex justify-center z-20 pointer-events-none">
                            <div className="flex items-center gap-6 bg-white px-6 py-3 rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.12)] pointer-events-auto border border-gray-100">
                                <button onClick={startScanFlow} className="relative -top-6">
                                    <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-blue-300 shadow-lg transform rotate-3 hover:rotate-6 transition-transform border-4 border-white">
                                        <Icon name="scan-line" size={32} className="text-white" />
                                    </div>
                                </button>
                                <button onClick={handleManualAdd} className="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition-colors">
                                    <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center"><Icon name="edit" size={20} /></div>
                                    <span className="text-[10px] font-bold">æ‰‹å‹•</span>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
