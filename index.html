<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapCard AI - 相機偵錯版</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes scan {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(200px); opacity: 0; }
        }
        .scan-line { animation: scan 2s linear infinite; background: linear-gradient(to bottom, transparent, #3b82f6); height: 2px; width: 100%; }
        body { background-color: #000; color: white; margin: 0; overflow: hidden; }
        video { object-fit: cover; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function App() {
            const [status, setStatus] = useState("等待啟動...");
            const [error, setError] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            // 核心功能：啟動鏡頭
            const startCamera = async () => {
                setStatus("正在請求相機權限...");
                setError(null);
                
                try {
                    // 檢查瀏覽器是否支援
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error("您的瀏覽器不支援相機功能，請換用 Safari 或 Chrome。");
                    }

                    const constraints = { 
                        video: { 
                            facingMode: { ideal: "environment" }, // 強制後鏡頭
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        } 
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        // 重要：iOS 需要在視訊準備好後才顯示
                        videoRef.current.onloadedmetadata = () => {
                            videoRef.current.play();
                            setIsScanning(true);
                            setStatus("相機運作中");
                        };
                    }
                } catch (err) {
                    console.error(err);
                    setError(`啟動失敗: ${err.message}`);
                    setStatus("失敗");
                }
            };

            const takePhoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (video && canvas) {
                    const ctx = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    setCapturedImage(canvas.toDataURL('image/png'));
                    setIsScanning(false);
                    
                    // 停用相機流
                    const stream = video.srcObject;
                    if (stream) stream.getTracks().forEach(t => t.stop());
                }
            };

            return (
                <div className="flex flex-col h-screen relative font-sans">
                    {/* 狀態欄 */}
                    <div className="p-4 bg-black/80 flex justify-between items-center z-20">
                        <span className="text-xs font-mono text-blue-400">{status}</span>
                        {error && <span className="text-xs text-red-500 bg-red-100/10 px-2 py-1 rounded">{error}</span>}
                    </div>

                    {/* 相機預覽區 */}
                    <div className="flex-1 relative bg-gray-900 flex items-center justify-center">
                        {!capturedImage ? (
                            <video ref={videoRef} playsInline muted className="h-full w-full" />
                        ) : (
                            <img src={capturedImage} className="max-h-full max-w-full" alt="Captured" />
                        )}

                        {/* 掃描框 */}
                        {isScanning && (
                            <div className="absolute inset-0 flex items-center justify-center p-10 pointer-events-none">
                                <div className="w-full aspect-[1.6/1] border-2 border-blue-500/50 rounded-lg relative overflow-hidden shadow-[0_0_0_1000px_rgba(0,0,0,0.6)]">
                                    <div className="scan-line absolute top-0"></div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* 按鈕控制區 */}
                    <div className="p-10 bg-black flex justify-center items-center gap-6 z-20">
                        {!isScanning && !capturedImage ? (
                            <button 
                                onClick={startCamera}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-full font-bold shadow-lg"
                            >
                                啟動相機
                            </button>
                        ) : capturedImage ? (
                            <button 
                                onClick={() => { setCapturedImage(null); startCamera(); }}
                                className="bg-white/20 text-white px-8 py-4 rounded-full font-bold"
                            >
                                重拍
                            </button>
                        ) : (
                            <button 
                                onClick={takePhoto}
                                className="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center"
                            >
                                <div className="w-16 h-16 bg-white rounded-full active:scale-90 transition-transform"></div>
                            </button>
                        )}
                    </div>

                    <canvas ref={canvasRef} className="hidden"></canvas>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
